# План рефакторинга n8n-nodes-telepilot

Этот план описывает шаги по рефакторингу проекта `n8n-nodes-telepilot` с целью минимизации сторонних зависимостей от `@telepilotco`, оптимизации процесса публикации NPM пакета с помощью Github Action и отчистки неиспользуемого легаси кода.

**Важно:** После выполнения каждого этапа или значительного изменения, создавайте коммит в Git.

## Этап 1: Анализ и удаление некритичного легаси

*   `[x]` **Задача 1.1:** Проанализировать и удалить скрипт `deploy/publish.sh`.
    *   **Обоснование:** Публикация управляется через GitHub Actions (`publish.yml`). Этот скрипт, вероятно, является устаревшим ручным методом.
    *   **Действия:** Проверить, не используется ли скрипт в каких-либо других процессах. Если нет - удалить.
*   `[x]` **Задача 1.2:** Проанализировать и удалить цели `publish` и `dryrun` из `Makefile`.
    *   **Обоснование:** GitHub Actions (`publish.yml` и `publish-check.yml`) уже выполняют эти функции (публикация и сухой прогон).
    *   **Действия:** Убедиться, что локальные вызовы `make publish` или `make dryrun` не являются частью основного рабочего процесса разработчиков. Если нет - удалить цели.
*   `[x]` **Задача 1.3:** Удалить скрипт `deploy/npm-telepilot-co.sh`.
    *   **Обоснование:** Кастомный NPM registry `npm.telepilot.co:4873` не используется. Публикация осуществляется на стандартный NPM registry (`npmjs.org`) через GitHub Actions.
    *   **Действия:** Удалить файл `deploy/npm-telepilot-co.sh`.

## Этап 2: Оптимизация процесса публикации NPM

*   `[x]` **Задача 2.1:** Оптимизировать GitHub Action `publish.yml` для использования стандартного NPM registry.
    *   **Обоснование:** Кастомный NPM registry `npm.telepilot.co:4873` не используется. Необходимо полностью перейти на `https://registry.npmjs.org`.
    *   **Действия:** 
        *   Установить `inputs.npm_registry` в `https://registry.npmjs.org` и удалить возможность его изменения.
        *   Удалить всю логику, связанную с `CUSTOM_REGISTRY_AUTH` и переменными для кастомного registry.
        *   Убедиться, что для публикации используется `NODE_AUTH_TOKEN: ${{ secrets.REGISTRY_TOKEN }}` и `actions/setup-node` с `registry-url: 'https://registry.npmjs.org'`.
        *   Удалить шаг `dkershner6/use-npm-token-action@v1`, так как `actions/setup-node` достаточно.
        *   Удалить `npm config set strict-ssl false`, так как для `registry.npmjs.org` это не требуется.
*   `[x]` **Задача 2.2:** Обновить GitHub Action `publish-check.yml` для использования стандартного NPM registry.
    *   **Обоснование:** Аналогично `publish.yml`, `publish-check.yml` должен использовать `https://registry.npmjs.org`.
    *   **Действия:** Синхронизировать логику установки registry с обновленным `publish.yml`, удалив все упоминания кастомного registry.

## Этап 3: Анализ и минимизация зависимостей @telepilotco

*   `[]` **Задача 3.1:** Заменить зависимость `@telepilotco/tdl` (`^7.4.1`) на `tdl` (`https://github.com/eilvelia/tdl`).
    *   **Обоснование:** Переход на открытую и поддерживаемую альтернативу для работы с TDLib.
    *   **Действия:** 
        *   Удалить `@telepilotco/tdl` из зависимостей.
        *   Добавить `tdl` (от `eilvelia`) в зависимости.
        *   Проанализировать API новой библиотеки и адаптировать существующий код для работы с ней. Это может потребовать значительных изменений в `TelePilotNodeConnectionManager.ts` и других файлах, использующих TDLib.
        *   Протестировать совместимость и функциональность.
*   `[]` **Задача 3.2:** Обновить или заменить зависимость для бинарных файлов TDLib в соответствии с выбранной на Этапе 3.1 библиотекой `tdl`.
    *   **Обоснование:** Библиотека `tdl` от `eilvelia` может иметь свои рекомендации по установке бинарных файлов TDLib (например, через `prebuilt-tdlib` или системную установку). <mcreference link="https://github.com/eilvelia/tdl" index="0">0</mcreference>
    *   **Действия:** 
        *   Удалить `@telepilotco/tdlib-binaries-prebuilt`.
        *   Следуя документации `tdl` (eilvelia), установить необходимые бинарные файлы TDLib. Это может включать установку `prebuilt-tdlib` или настройку путей к системным библиотекам. <mcreference link="https://github.com/eilvelia/tdl" index="0">0</mcreference>
        *   Убедиться, что `tdl.configure({ tdjson: getTdjson() })` или аналогичный механизм используется для указания пути к `libtdjson`. <mcreference link="https://github.com/eilvelia/tdl" index="0">0</mcreference>
        *   Проверить совместимость на всех целевых платформах (Linux x64/arm64, macOS x64/arm64). <mcreference link="https://github.com/eilvelia/tdl" index="0">0</mcreference> <mcreference link="https://www.npmjs.com/package/@telecopilotco/n8n-nodes-telepilot" index="1">1</mcreference>

## Этап 4: Очистка легаси кода в директории `deploy`

*   `[]` **Задача 4.1:** Удалить скрипты из директории `deploy/aws-test/`.
    *   **Обоснование:** Эти скрипты не используются в текущем пайплайне разработки и тестирования.
    *   **Действия:** Удалить все файлы из директории `deploy/aws-test/`.
*   `[]` **Задача 4.2:** Удалить содержимое директории `deploy/n8n-dockerfile-installation/`.
    *   **Обоснование:** Файлы и скрипты в этой директории не используются в текущем пайплайне разработки и тестирования. Логика сборки Docker для тестов централизована в GitHub Actions.
    *   **Действия:** Удалить все файлы из директории `deploy/n8n-dockerfile-installation/`.

## Этап 5: Общий анализ и рефакторинг кода (более сложный)

*   `[]` **Задача 5.1:** Провести аудит остального кода на предмет неиспользуемых или устаревших частей.
    *   **Обоснование:** После удаления явного легаси и оптимизации зависимостей, могут остаться неиспользуемые функции, модули или конфигурации.
    *   **Действия:** Использовать инструменты статического анализа, анализ покрытия кода (если есть тесты) и ручной просмотр для выявления таких участков.
*   `[]` **Задача 5.2 (Опционально/Сложно):** Рефакторинг кода для уменьшения прямой зависимости от функционала библиотек `@telepilotco`, если это возможно и целесообразно.
    *   **Обоснование:** Если анализ на Этапе 3 показал, что части функционала `@telepilotco/tdl` можно заменить или реализовать иначе.
    *   **Действия:** Это потребует глубокого понимания кода и может быть значительной задачей. Выполнять только при явной выгоде (упрощение, повышение стабильности, снижение затрат на поддержку).

---
Пожалуйста, обновляйте статусы задач по мере их выполнения.
